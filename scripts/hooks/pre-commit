#!/usr/bin/env bash
# Pre-commit hook to validate codecov.yml changes
# Works on Windows (Git Bash), Linux, and macOS

# Check if codecov.yml is being committed
if git diff --cached --name-only | grep -q "^codecov\.yml$"; then
    echo "Validating codecov.yml..."

    # Use curl to validate the configuration (cross-platform)
    response=$(curl -s -X POST https://codecov.io/validate \
        -H "Content-Type: application/x-yaml" \
        --data-binary @codecov.yml)

    # Check if validation was successful
    if echo "$response" | grep -q "Valid!"; then
        echo "✓ codecov.yml is valid"
        exit 0
    else
        echo "✗ codecov.yml validation failed:"
        echo "$response"
        echo ""
        echo "Please fix the errors above before committing."
        echo "You can manually validate with:"
        echo "  curl -X POST https://codecov.io/validate -H 'Content-Type: application/x-yaml' --data-binary @codecov.yml"
        exit 1
    fi
fi

exit 0
